# Configuration file for Travis CI builds,
# which are automatically run when code is pushed to Github.
# To skip a build, add [ci skip] to the commit message.
# This file has been linted using: http://lint.travis-ci.org/

# Use PHP, to use Composer, WordPress and PHPUnit
language: php

# PHP versions to test against
# https://github.com/meitar/wordpress-plugin-skeleton/blob/master/.travis.yml
php:
  - 7.3.7 # MAMP

# Public Environment Variables
# https://docs.travis-ci.com/user/environment-variables
# https://github.com/meitar/wordpress-plugin-skeleton/blob/master/.travis.yml
env:
  - WP_VERSION=latest WP_MULTISITE=0

# Build Matrix
# consisting of specific runtime/env/exclude/include combinations.
# Each 'include' is run as a separate job.
# https://docs.travis-ci.com/user/customizing-the-build/#Build-Matrix
# https://github.com/meitar/wordpress-plugin-skeleton/blob/master/.travis.yml
matrix:
  # reduce the delay in the build status being reported
  # https://johnblackbourn.com/reducing-travis-ci-build-times-for-wordpress-projects/
  fast_finish: true
  include:
    - php: 7.3.7
      env: WP_VERSION=latest WP_MULTISITE=0

# Start MySQL
services:
  - mysql

# Cache directories between builds, to store dependencies
# which take longer to compile or download.
# https://docs.travis-ci.com/user/caching#Caching-directories-(Bundler%2C-dependencies)
# https://github.com/wp-cli/sample-plugin/blob/master/.travis.yml
# https://johnblackbourn.com/reducing-travis-ci-build-times-for-wordpress-projects/
# ~/files - https://blog.wyrihaximus.net/2015/07/composer-cache-on-travis/
cache:
  directories:
#   - node_modules
#   - vendor
#    - $HOME/.composer/cache/files
    - $HOME/.npm 

before_install:
  # Install a Second Programming Language (Node, to run Gulp tasks)
  # We need to specify a newer version than the Travis default
  # in order to avoid the build error "Use of const in strict mode"
  # https://docs.travis-ci.com/user/customizing-the-build/#Installing-a-Second-Programming-language
  # https://stackoverflow.com/a/44250453/6850747
  - nvm install 10.16.2
  # Disable XDebug which is only required for Code Coverage reports
  # https://johnblackbourn.com/reducing-travis-ci-build-times-for-wordpress-projects/
  - phpenv config-rm xdebug.ini
  # Install Mono (NaturalDocs dependency)
  # https://www.mono-project.com/download/stable/#download-lin-ubuntu
  - sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
  - sudo apt install apt-transport-https ca-certificates
  - echo "deb https://download.mono-project.com/repo/ubuntu stable-xenial main" | sudo tee /etc/apt/sources.list.d/mono-official-stable.list
  - sudo apt update
  - sudo apt install mono-complete
  # Install NaturalDocs
  # https://github.com/NaturalDocs/NaturalDocs/issues/39
  # Unzips to 'Natural Docs'
  - sudo apt-get install unzip
  - wget https://naturaldocs.org/download/natural_docs/2.0.2/Natural_Docs_2.0.2.zip && unzip Natural_Docs_2.0.2.zip
  # Unsure if this is required here, it is needed by generated plugins.
  # See dotherightthing/generator-wpdtrt-plugin-boilerplate#88
  - composer config -g github-oauth.github.com $GH_TOKEN

# Install dependencies
# https://docs.travis-ci.com/user/customizing-the-build/#Customizing-the-Installation-Step
# Note: Remember to run composer update on local dev to get latest updates to dependencies
# https://www.sitepoint.com/php-continuous-integration-travis-ci/
# https://getcomposer.org/doc/03-cli.md
install:
  - composer install --prefer-dist --no-interaction --no-suggest # loads parent plugin class, which in turn runs an install via gulpfile.js
  # Adding Yarn to Travis CI - https://gist.github.com/acburdine/61f4f91bacf6554fccdaa394fd14ebbd
  - npm install -g yarn
  - yarn install --non-interactive # child plugin
  - yarn global add gulp-cli

# Exporting a variable causes it to be inherited
# by subsequently started processes in the shell session
# See https://askubuntu.com/a/205698
# See https://stackoverflow.com/a/3035445/6850747
# See https://github.com/wp-cli/sample-plugin/blob/master/.travis.yml
before_script:
  - export PATH="$HOME/.composer/vendor/bin:$PATH"
  - export WPUNIT_DB_USER="root"
  - export WPUNIT_DB_PASS=""
  - export WPUNIT_DB_HOST="localhost"

# Run the build script
script:
  - yarn run build

# Notifications of build results
# https://docs.travis-ci.com/user/notifications/
# https://github.com/travis-ci/travis-ci/issues/6387 - $SLACK_AUTH not supported
notifications:
  email: false
  slack:
    secure: "ZNBGnCpiLYlm42Ibw3PetLhs6bVL1NZnL/nAOwtZ2Mw56gLs7TS8fJgX6xVoqcnL5QfszrCs4fv2+KsAW1dvePoxIBEA6SCH8rbSOtiK2LvvF2gU1sZUUEdfxWAUyNWAQu+N8aZyOf4Ewyuaqbnbmed8zU/AXSWUJ97WD446fFg/GU+ctRV/DR8H5avWW44wL7d6otUHU/n5qlnIkpj8qkE7uchJzE06wGBvTMOjMuoGfRo1Ko1j5akBwK2iuQ+DdCc5QFL4dIbK2tV+wbSIwzXEDxH7yK9zmQobM3HniL1OAesgDDhrX/bvfnFMvOMBbOKBzMKMz+g45CjH4C7xpqu1uI3NFytERD+M8Ke+tKJhsdxrUCc/nsWPiYjH8CXqn9WbAYpLJewqHTbMLkM37OS9zvWCPDW8s4Bzb6UvK7jkHvqULIIFp84DDXXn55eOCf/PYdE1sNDPmZg5JymCK+sGiAXFdbq6zjeRAziBzw+aEISeABjgDZuFwe+3JSqMzWKrtokdsLCYAGgOPfbuDPgmSPB3MpkTXB662qH0fG9UtYd4OU7N/Q88S7a+Xf0fuVL0oFfemnhhpziSTM0u6gpCJHDuOlwLykylN/hbkiVNm2z4xC2dWPfRoa640W42sFw8X/tEJfFxgmnGqkipyI+2Dv+AE8y9z+brxFNwfQU="

# Deploy code to Github as a 'release'
# This is run after a tagged commit triggers a successful build
# release.zip is generated by gulp
# $GITHUB_AUTH - see:
# https://github.com/dotherightthing/generator-wpdtrt-plugin-boilerplate#github-releases
deploy:
  provider: releases
  api_key:
    secure: $GH_TOKEN
  file: 'release.zip'
  # prevent Travis CI from resetting the working directory
  # which deletes all changes made during the build 
  skip_cleanup: true
  on:
    repo: dotherightthing/wpdtrt-plugin-boilerplate
    tags: true
    # https://stackoverflow.com/a/27775257/6850747
    all_branches: true
